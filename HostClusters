library(tidyverse)
library(XML)
library(factoextra)
library(mice)
library(gt)

# get data

url <- "http://insideairbnb.com/get-the-data.html"

htmlParse("http://insideairbnb.com/get-the-data.html")

doc <- htmlParse(url)
links <- xpathSApply(doc, "//a/@href")
US_links <- links[grepl("united-states", links)]
US_links <- US_links[grepl("2020-02", US_links)]
US_links <- US_links[grepl("listings", US_links)]
US_links <- US_links[!grepl("visualisations", US_links)]
free(doc)

summary(US_links) #of files

GetMe <- paste(US_links, sep = "")

listings <- lapply(as.vector(GetMe), function(x)
{con <- gzcon(url(x))
txt <- readLines(con)
dat <- read.csv(textConnection(txt, encoding = "UTF-8"))}
)

# create dataframe and clean data

listings.df <- do.call(rbind.data.frame,listings) 
listings.df$price <- as.numeric(gsub('[$,]', '', listings.df$price))
listings.df$host_response_rate <- as.numeric(gsub('[%]', '', listings.df$host_response_rate))
listings.df$host_acceptance_rate  <- as.numeric(gsub('[%]', '', listings.df$host_acceptance_rate))

# consolidate multiple listing count and estimate days occupied as minimum 3

listings.df <- listings.df %>% 
  mutate(max_listings=pmax(host_total_listings_count, host_listings_count, calculated_host_listings_count)) %>%
  mutate(price_per_accommodates=price/accommodates) %>% 
  mutate(days_occupied_estimate = if_else(minimum_nights_avg_ntm>3,minimum_nights_avg_ntm,3))

# remove outliers, estimate occupancy and generate host dataset
  
hosts <- listings.df %>% 
  filter(number_of_reviews>0, 
         minimum_nights_avg_ntm<=365, 
         number_of_reviews_ltm<365/days_occupied_estimate,
         price >0) %>%
  mutate(occupancy_estimate =(days_occupied_estimate*(number_of_reviews_ltm/0.5))/365) %>%
  mutate(occupancy_estimate=if_else(occupancy_estimate>0.7,0.7,occupancy_estimate)) %>%
  group_by(host_id) %>%
  summarise(
    max_listings=max(max_listings),
    avg_acceptance_rate=mean(host_acceptance_rate),
    avg_response_rate=mean(host_response_rate),
    avg_min_nights=mean(minimum_nights_avg_ntm),
    avg_occupancy_estimate=mean(occupancy_estimate),
    avg_price_per_accommodates=mean(price_per_accommodates),
    avg_accommodates=mean(accommodates),
    avg_reviews_ltm=mean(number_of_reviews_ltm))

#prepare host data for k-means clustering including imputing missing values

hosts <- data.frame(hosts)
hosts.filtered <- hosts %>% filter(max_listings<30 & avg_price_per_accommodates<200)
rownames(hosts.filtered) <- hosts.filtered$host_id
hosts.filtered <- hosts.filtered[,-c(1,8,9)]
summary(hosts.filtered) 

hosts.imputed <- mice(hosts.filtered, m=5, maxit=5, method="pmm")

hosts.scaled <- scale(complete(hosts.imputed))

#generate scree plot

k.max <- 15
data <- hosts.scaled
wss <- sapply(2:k.max,
              function(k){kmeans(data, k, nstart=5, iter.max=25)$tot.withinss})

wss.plot <- data.frame(k=c(2:15), wss)

ggplot(wss.plot, aes(x=k, y=wss)) +
  geom_point() + 
  geom_line() +
  ggtitle("Scree Plot")

# scree plot shows 7 is an appropriate number of clusters. Create model, visualize and append to host dataframe 

hosts.model <- kmeans(hosts.scaled, centers=7, nstart=5)

fviz_cluster(hosts.model, data = hosts.scaled,
             ellipse.type = "convex", 
             geom = "point",
             ggtheme = theme_bw())

hosts.filtered <- rownames_to_column(hosts.filtered,var="host_id")

hosts.filtered <- hosts.filtered %>% 
  mutate(cluster = hosts.model$cluster) %>%
  mutate(acceptance_imputed = is.na(avg_acceptance_rate)) %>%
  mutate(response_imputed = is.na(avg_response_rate))

hosts <- merge(x = hosts, y = hosts.filtered[, c("host_id", "cluster", "acceptance_imputed", "response_imputed")], by = "host_id", all.x=TRUE) 

# create clusters from outliers removed from K-means clustering

hosts$cluster <- as.numeric(hosts$cluster)

hosts <- hosts %>% 
  mutate(cluster = if_else(max_listings>=30, 8, cluster)) %>%
  mutate(cluster = if_else(avg_price_per_accommodates>=200, 9, cluster))

# summarize average of cluster variables for presentation

host.clusters <- hosts %>% 
                      group_by(cluster) %>%
                      summarise(
                        count=n(),
                          avg_max_listings=mean(max_listings),
                          avg_acceptance_rate=mean(avg_acceptance_rate,na.rm=TRUE)/100,
                          avg_response_rate=mean(avg_response_rate,na.rm=TRUE)/100,
                          avg_min_nights=mean(avg_min_nights),
                          avg_occupancy_estimate=mean(avg_occupancy_estimate),
                          avg_price_per_accommodates=mean(avg_price_per_accommodates),
                          acceptance_imputed=sum(acceptance_imputed,na.rm=TRUE),
                          response_imputed=sum(response_imputed,na.rm = TRUE),
                          avg_accommodates=mean(avg_accommodates),
                          avg_reviews_ltm=mean(avg_reviews_ltm))

host.clusters <- host.clusters %>% filter(!is.na(cluster))

x <- data.frame(host.clusters)
write.table(x, "clipboard", sep="\t", row.names=FALSE)

# estimate number of listings and approximate value of segments

host.clusters <- host.clusters %>% 
  mutate(value=(count*avg_max_listings*(365*avg_occupancy_estimate)*(avg_accommodates*avg_price_per_accommodates))) %>% 
  mutate(value_percent=value/sum(value)) %>%
  mutate(estimated_listing_count=count*avg_max_listings) %>%
  mutate(estimated_listing_count_percent=count*avg_max_listings/sum(count*avg_max_listings)) %>%
  mutate(host_percent=count/sum(count))

# name clusters and prepare final tables for presentation 

host.clusters$cluster_name <- c(
  "Full-time Multi-Unit",
  "Full-time Long-term",
  "Part-time Selective",
  "Part-time Active",
  "Part-time Passive",
  "Full-time Active",
  "Full-time High-priced",
  "Management Entity",
  "Full-time Luxury")

host.clusters %>% 
  arrange(desc(value)) %>%
  select(cluster_name, count, avg_max_listings, avg_acceptance_rate, avg_response_rate, avg_min_nights, avg_occupancy_estimate, avg_price_per_accommodates) %>%
  gt(rowname_col = "cluster_name") %>%
  fmt_number(vars(count), decimals=0, sep_mark = ",") %>%
  fmt_percent(vars(avg_acceptance_rate, avg_response_rate, avg_occupancy_estimate), decimals=0) %>%
  fmt_number(vars(avg_max_listings, avg_min_nights), decimals=2) %>%
  fmt_currency(vars(avg_price_per_accommodates)) %>%
  cols_label(cluster_name = "Cluster Name", 
             count = "Host Count", 
             avg_max_listings = "Avg. Listing Count", 
             avg_acceptance_rate = "Avg. Acceptance Rate", 
             avg_response_rate = "Avg. Response Rate", 
             avg_min_nights = "Avg. Minimum Nights", 
             avg_occupancy_estimate = "Avg. Occupancy Estimate", 
             avg_price_per_accommodates = "Avg. Price per Person") %>%
  data_color(vars(count, avg_max_listings, avg_min_nights, avg_occupancy_estimate, avg_price_per_accommodates), colors = scales::col_numeric(
    palette = c("transparent","powderblue"), 
    domain = NULL)) %>% 
  data_color(vars( avg_acceptance_rate, avg_response_rate), colors = scales::col_numeric(
    palette = c("powderblue","transparent"), 
    domain = NULL)) %>%
  tab_options(column_labels.font.weight="bold", table.font.size=12) %>%
  cols_width(vars(cluster_name) ~ px(140),
             vars(count, avg_max_listings, avg_acceptance_rate, avg_response_rate, avg_min_nights, avg_occupancy_estimate, avg_price_per_accommodates) ~ px(80)) %>%
  cols_align(align = "center",
           columns = vars(count, avg_max_listings, avg_acceptance_rate, avg_response_rate, avg_min_nights, avg_occupancy_estimate, avg_price_per_accommodates))
  


host.clusters %>% 
  arrange(desc(value)) %>%
  mutate(value=value/1000) %>%
  select(cluster_name, count, host_percent, estimated_listing_count, estimated_listing_count_percent, value, value_percent) %>%
  gt(rowname_col = "cluster_name") %>%
  fmt_number(vars(count, estimated_listing_count), decimals=0, sep_mark = ",") %>%
  fmt_percent(vars(host_percent, estimated_listing_count_percent, value_percent), decimals=0) %>%
  fmt_currency(vars(value), decimals=0, suffixing=c("M")) %>%
  cols_label(cluster_name = "Cluster Name", 
             count = "Host Count", 
             host_percent = "% of Total Hosts", 
             estimated_listing_count = "Listing Count", 
             estimated_listing_count_percent = "% of Total Listings", 
             value = "Estimated Value", 
             value_percent = "% of Total Value") %>%
  data_color(vars(count, host_percent, estimated_listing_count, estimated_listing_count_percent, value, value_percent), colors = scales::col_numeric(
    palette = c("transparent","powderblue"), 
    domain = NULL)) %>%
  tab_options(column_labels.font.weight="bold", table.font.size=12) %>%
  cols_width(vars(cluster_name) ~ px(140),
             vars(count, host_percent, estimated_listing_count, estimated_listing_count_percent, value, value_percent) ~ px(90)) %>%
  cols_align(align = "center",
    columns = vars(count, host_percent, estimated_listing_count, estimated_listing_count_percent, value, value_percent))




